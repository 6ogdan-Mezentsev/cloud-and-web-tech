name: Good CI/CD

on:
  push:
    branches:
      - main   # BEST PRACTICE: деплой только из основной (production) ветки

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          # BEST PRACTICE: использование GitHub Secrets для хранения секретных данных
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # BEST PRACTICE: CI собирает и публикует готовый Docker-образ
          # BEST PRACTICE: сервер получает уже готовый образ, не делая build
          context: ./lab2/pr1
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/express-lab2:latest

  test:
    name: Test API
    runs-on: ubuntu-latest
    needs: build   # BEST PRACTICE: тесты запускаются только после успешной сборки образа

    steps:
        # BEST PRACTICE: тестируется уже опубликованный Docker-образ
      - name: Pull image
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/express-lab2:latest

      - name: Run container
        run: |
          docker run -d -p 8001:8001 --name test_container \
            ${{ secrets.DOCKERHUB_USERNAME }}/express-lab2:latest

        # BEST PRACTICE: тест проверяет доступность ручки API и корректность ответа
      - name: Run test
        run: |
          sleep 5
          STATUS=$(curl -s -o response.json -w "%{http_code}" http://localhost:8001/api/hello)
          cat response.json
          [ "$STATUS" -eq 200 ]
          grep -q "Приветули" response.json

        # BEST PRACTICE: очистка ресурсов выполняется даже при падении тестов
      - name: Cleanup
        if: always()
        run: |
          docker rm -f test_container

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: test   # BEST PRACTICE: деплой возможен только после успешных тестов

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # BEST PRACTICE: аутентификация по SSH-ключу вместо пароля
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/express-lab2:latest
            docker stop express || true
            docker rm express || true
            docker run -d \
              --name express \
              -p 8001:8001 \
              ${{ secrets.DOCKERHUB_USERNAME }}/_
